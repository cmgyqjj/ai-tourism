<view class="page">
  <!-- 地图展示区域 -->
  <view class="map-container">
    <map 
      id="routeMap"
      class="map"
      longitude="{{mapCenter.longitude}}" 
      latitude="{{mapCenter.latitude}}"
      scale="{{mapScale}}"
      markers="{{markers}}"
      polyline="{{polyline}}"
      show-location="{{true}}"
      enable-3D="{{false}}"
      show-compass="{{false}}"
      enable-overlooking="{{false}}"
      enable-zoom="{{true}}"
      enable-scroll="{{true}}"
      enable-rotate="{{false}}"
      bindload="onMapLoad"
      binderror="onMapError"
      bindmarkertap="onMarkerTap"
      bindregionchange="onRegionChange">
    </map>
    

    
    <!-- 返回按钮放在地图左上角 -->
    <view class="back-btn" bindtap="goBack">
      <text class="back-arrow">←</text>
    </view>
    
    <!-- 调试按钮 -->
    <!-- <view class="debug-btn" bindtap="testMap">
      <text class="debug-text">测试地图</text>
    </view> -->
  </view>

  <!-- 状态1: 初始加载状态 -->
  <view class="loading-state" wx:if="{{currentState === 'loading'}}">
    <view class="loading-container">
      <view class="loading-header">
        <image class="ai-avatar" src="/images/route-optimization/ai.png" />
        <text class="loading-title">AI正在分析您的行程...</text>
      </view>
      
      <view class="loading-dots">
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
      </view>
      
      <view class="loading-text">请稍等，正在为您优化路线</view>
    </view>
  </view>

  <!-- 状态2: 问题选择状态 -->
  <view class="question-selection-state" wx:if="{{currentState === 'selecting'}}">
    <view class="question-container">
      <view class="question-header">
        <image class="ai-avatar" src="/images/route-optimization/ai.png" />
        <text class="question-title">选择需要优化的问题：</text>
      </view>
      
      <view class="question-list">
        <view wx:for="{{currentQuestions}}" wx:key="index" 
              class="{{getQuestionItemClass(index)}}" 
              bindtap="selectQuestion" data-index="{{index}}">
          <view class="question-content">
            <text class="question-text">{{item.title}}</text>
            <text class="question-desc">({{item.desc}})</text>
            <text class="arrow">→</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 底部按钮区域 -->
    <view class="bottom-buttons">
      <!-- 调试信息 -->
      <view class="debug-info">
        <text>已选择: {{selectedQuestions ? selectedQuestions.length : 0}} 个问题</text>
      </view>
      
      <!-- 确认按钮 -->
      <view wx:if="{{selectedQuestions && selectedQuestions.length > 0}}" class="confirm-btn-wrapper">
        <button class="btn confirm" bindtap="confirmSelection">确认提交</button>
      </view>
      
      <!-- 换一批按钮 -->
      <view class="change-batch-btn" bindtap="changeBatch">
        <text class="btn-text">都不是，换一批</text>
      </view>
    </view>
  </view>

  <!-- 状态3: AI思考状态 -->
  <view class="thinking-state" wx:if="{{currentState === 'thinking'}}">
    <view class="thinking-container">
      <view class="thinking-header">
        <image class="ai-avatar" src="/images/route-optimization/ai.png" />
        <text class="thinking-title">AI正在思考中...</text>
      </view>
      
      <view class="thinking-problems">
        <view wx:for="{{selectedQuestions || []}}" wx:key="index" 
              class="thinking-problem-item">
          <text class="thinking-problem-text">
            {{currentQuestions[item].title}} ({{currentQuestions[item].desc}})
          </text>
        </view>
      </view>

      <view class="thinking-loading">
        <view class="thinking-dots">
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
        </view>
      </view>

      <view class="thinking-buttons">
        <button class="btn cancel" bindtap="returnToSelection">返回问题选择</button>
      </view>
    </view>
  </view>
</view>
