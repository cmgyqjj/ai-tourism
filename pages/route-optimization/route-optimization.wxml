<view class="page">
  <!-- 地图展示区域 -->
  <view class="map-container">
    <view class="map-wrapper">
      <map 
        id="routeMap"
        class="map"
        longitude="{{mapCenter.longitude}}" 
        latitude="{{mapCenter.latitude}}"
        scale="{{mapScale}}"
        markers="{{markers}}"
        polyline="{{polyline}}"
        show-location="{{true}}"
        enable-3D="{{false}}"
        show-compass="{{false}}"
        enable-overlooking="{{false}}"
        enable-zoom="{{true}}"
        enable-scroll="{{true}}"
        enable-rotate="{{false}}"
        bindload="onMapLoad"
        binderror="onMapError"
        bindmarkertap="onMarkerTap"
        bindregionchange="onRegionChange">
      </map>
    </view>
    

    
    <!-- 返回按钮放在地图左上角 -->
    <view class="back-btn" bindtap="goBack">
      <text class="back-arrow">‹</text>
    </view>
    
    <!-- 调试按钮区域 -->
    <view class="debug-buttons">
    </view>
  </view>

  <!-- 状态1: 初始加载状态 -->
  <view class="loading-state" wx:if="{{currentState === 'loading'}}">
    <view class="loading-container">
      <view class="loading-header">
        <image class="ai-avatar" src="https://p0.meituan.net/hackathonqjj/1f80a8749cf500a99c5d24805ab395aa16044.png" />
        <text class="loading-title">告诉ai你的优化需求吧~</text>
      </view>
      
      <view class="loading-dots">
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
      </view>
    </view>
  </view>

  <!-- 状态2: 问题选择状态 -->
  <view class="question-selection-state" wx:if="{{currentState === 'selecting'}}">
    <view class="question-container">
      <view class="question-header">
        <image class="ai-avatar" src="https://p0.meituan.net/hackathonqjj/1f80a8749cf500a99c5d24805ab395aa16044.png" />
        <text class="question-title">选择需要优化的问题：</text>
      </view>
      
      <view class="question-list">
        <view wx:for="{{currentQuestions}}" wx:key="index" 
              bindtap="selectQuestion" data-index="{{index}}">
          
          <!-- 选中状态 -->
          <view wx:if="{{questionStates[index]}}" class="question-item selected">
            <view class="question-content">
              <text class="question-text">{{item.title}}</text>
              <text class="question-desc">({{item.desc}})</text>
              <text class="arrow">→</text>
            </view>
          </view>
          
          <!-- 未选中状态 -->
          <view wx:else class="question-item">
            <view class="question-content">
              <text class="question-text">{{item.title}}</text>
              <text class="question-desc">({{item.desc}})</text>
              <text class="arrow">→</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 底部按钮区域 -->
      <view class="bottom-buttons">
        <!-- 换一批按钮 -->
        <button class="btn change-batch {{selectedCount > 0 ? 'has-selection' : ''}}" style="width: 145px;" bindtap="changeBatch">
          <image class="refresh-icon" src="https://p0.meituan.net/hackathonqjj/ccd1ed86f0302ed992c7b59e961db80c1011.png" mode="aspectFit"></image>
          <text class="change-batch-text">都不是，换一批</text>
        </button>
      </view>
      
      <!-- 确认提交按钮 - 单独放在下面一行 -->
      <view wx:if="{{selectedCount > 0}}" class="confirm-btn-wrapper">
        <button class="btn confirm" bindtap="confirmSelection">确认提交</button>
      </view>
    </view>
  </view>

  <!-- 状态3: AI思考状态 -->
  <view class="thinking-state" wx:if="{{currentState === 'thinking'}}">
    <view class="thinking-container">
      <view class="thinking-header">
        <image class="ai-avatar" src="/images/route-optimization/ai.png" />
        <text class="thinking-title">AI正在思考中...</text>
      </view>
      
      <view class="thinking-problems">
        <view wx:for="{{selectedQuestions}}" wx:key="*this" 
              class="thinking-problem-item">
          <view class="question-content">
            <text class="question-text">{{currentQuestions[item].title}}</text>
            <text class="question-desc">({{currentQuestions[item].desc}})</text>
            <text class="arrow">→</text>
          </view>
        </view>
      </view>

      <view class="thinking-loading">
        <view class="thinking-dots">
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
          <view class="thinking-dot"></view>
        </view>
      </view>

      <view class="thinking-instruction">
        您确认问题后, AI会重新生成新攻略, 将覆盖现有内容, 点击下方确认即可更新...
      </view>

      <view class="thinking-buttons">
        <button class="btn confirm-update" bindtap="confirmUpdate">
          <view class="check-icon">✓</view>
          <text>确认更新</text>
        </button>
        <button class="btn return-btn" bindtap="returnToSelection">不改了，返回</button>
      </view>
    </view>
  </view>
</view>
