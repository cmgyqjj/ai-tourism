<!--create-trip.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="nav-left" bindtap="goBack">
      <text class="back-icon">â†</text>
    </view>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    <!-- æœç´¢åŒºåŸŸ -->
    <view class="search-section">
      <view class="search-question">
        <text>å®ï¼Œä½ ä»¬æƒ³å»å“ªé‡Œï¼Ÿ</text>
      </view>
      <view class="search-bar" bindtap="showDestinationSelector">
        <view class="search-icon">ğŸ”</view>
        <view class="search-input">
          <text class="placeholder" wx:if="{{!selectedDestination}}">è¾“å…¥ç›®çš„åœ°ã€æ™¯ç‚¹ã€æ´»åŠ¨ç­‰</text>
          <text class="selected-text" wx:else>{{selectedDestination}}</text>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´é€‰æ‹©åŒºåŸŸ - åªæœ‰åœ¨é€‰æ‹©äº†ç›®çš„åœ°åæ‰æ˜¾ç¤º -->


    <!-- çµæ´»å¤©æ•°è¾“å…¥åŒºåŸŸ - åªæœ‰åœ¨é€‰æ‹©äº†ç›®çš„åœ°åæ‰æ˜¾ç¤º -->
    <view class="flexible-duration-section" wx:if="{{selectedDestination}}">
      <view class="flexible-duration-question">
        <text>å®ï¼Œä½ ä»¬æƒ³è¦ç©å¤šä¹…ï¼Ÿ</text>
      </view>
      <view class="flexible-duration-input-container">
        <view class="flexible-duration-icon">ğŸ“…</view>
        <input 
          class="flexible-duration-input" 
          placeholder="é€‰æ‹©æ—…è¡Œå¤©æ•°æˆ–æ—¥æœŸ" 
          value="{{flexibleDurationText}}"
          bindtap="showTimeSelector"
          disabled="true"
        />
      </view>
    </view>

    <!-- æ—…è¡Œæ­å­æ•°é‡è¾“å…¥åŒºåŸŸ - åªæœ‰åœ¨é€‰æ‹©äº†æ—¶é—´æˆ–çµæ´»å¤©æ•°åæ‰æ˜¾ç¤º -->
    <view class="companion-section" wx:if="{{flexibleDurationText}}">
      <view class="companion-question">
        <text>å®ï¼Œæœ¬æ¬¡æ—…è¡Œå‡ ä¸ªæ­å­ï¼Ÿ</text>
      </view>
      <view class="companion-input-container">
        <view class="companion-icon">ğŸ‘¥</view>
        <input 
          class="companion-input" 
          placeholder="è¾“å…¥æ­å­æ•°é‡ (æœ€å¤š3äºº)" 
          value="{{companionCount}}"
          bindinput="onCompanionInput"
          bindfocus="onCompanionFocus"
          bindblur="onCompanionBlur"
          maxlength="1"
          type="number"
        />
      </view>
    </view>

    <!-- åˆ†äº«å¥½å‹åŒºåŸŸ - åªæœ‰åœ¨è¾“å…¥äº†æ­å­æ•°é‡åæ‰æ˜¾ç¤º -->
    <view class="share-section" wx:if="{{companionCount}}">
      <view class="share-title">
        <text>åˆ†äº«å¥½å‹ï¼Œå…è´¹è§£é”AIæ™ºèƒ½è§„åˆ’</text>
      </view>
      <view class="share-avatars">
        <view class="current-user-avatar">
          <image wx:if="{{userAvatar}}" src="{{userAvatar}}" class="avatar-image" />
          <view wx:else class="avatar-placeholder">ğŸ‘¤</view>
        </view>
        <!-- æ˜¾ç¤ºæ­å­å¤´åƒ -->
        <view wx:for="{{companionAvatars}}" wx:key="index" class="companion-avatar">
          <image wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" class="avatar-image" />
          <view wx:else class="avatar-placeholder">{{item.placeholder}}</view>
        </view>
      </view>
      <view class="share-buttons">
        <button class="share-wechat-btn" open-type="share" wx:if="{{companionCount > 0}}">åˆ†äº«å¾®ä¿¡ç¾¤</button>
        <button class="do-myself-btn" bindtap="doItMyself" wx:if="{{companionCount > 0 && hasShared}}">
          <text class="do-myself-text">è‡ªå·±æå®š</text>
        </button>
        <button class="do-myself-btn" bindtap="doItMyself" wx:if="{{companionCount == 0}}">
          <text class="do-myself-text">è‡ªå·±æå®š</text>
        </button>
      </view>
    </view>
  </view>

  <!-- ç›®çš„åœ°é€‰æ‹©å™¨ -->
  <view class="destination-selector" wx:if="{{showSelector}}" bindtap="hideDestinationSelector">
    <view class="selector-content" catchtap="stopPropagation">
      <!-- é€‰æ‹©å™¨å¤´éƒ¨ -->
      <view class="selector-header">
        <view class="header-left" bindtap="goBack">
          <text class="back-icon">â†</text>
        </view>
        <view class="header-tabs">
          <view class="tab-item {{tabType === 'single' ? 'active' : ''}}" bindtap="switchTab" data-type="single">
            <text>å•é€‰ç›®çš„åœ°</text>
          </view>
          <view class="tab-item {{tabType === 'multiple' ? 'active' : ''}}" bindtap="switchTab" data-type="multiple">
            <text>å¤šé€‰ç›®çš„åœ°</text>
          </view>
        </view>
        <view class="header-right" bindtap="hideDestinationSelector">
          <text class="close-icon">âœ•</text>
        </view>
      </view>

      <!-- æœç´¢æ  -->
      <view class="selector-search">
        <view class="search-input-container">
          <text class="search-icon-small">ğŸ”</text>
          <input class="search-input-field" placeholder="æœç´¢æœºåœºã€åŸå¸‚ã€å›½å®¶..." value="{{searchKeyword}}" bindinput="onSearchInput" />
        </view>
      </view>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <view class="selector-main">
        <!-- å·¦ä¾§åˆ†ç±»åˆ—è¡¨ -->
        <scroll-view class="category-sidebar" 
              id="categorySidebar"
              scroll-y="true"
              enhanced="true"
              show-scrollbar="true"
              bindtouchstart="onTouchStart"
              bindtouchmove="onTouchMove"
              bindtouchend="onTouchEnd">
          <view class="category-item {{currentCategory === item.key ? 'active' : ''}}" 
                wx:for="{{categories}}" 
                wx:key="key" 
                bindtap="selectCategory" 
                data-category="{{item.key}}">
            <text>{{item.name}}</text>
          </view>
        </scroll-view>

        <!-- å³ä¾§ç›®çš„åœ°åˆ—è¡¨ -->
        <scroll-view class="destination-list" 
              id="destinationList"
              scroll-y="true"
              enhanced="true"
              show-scrollbar="true"
              bindtouchstart="onTouchStart"
              bindtouchmove="onTouchMove"
              bindtouchend="onTouchEnd">
          <view class="list-header">
            <text class="list-title">{{currentCategoryName}}</text>
            <!-- å¤šé€‰æ¨¡å¼ä¸‹æ˜¾ç¤ºå·²é€‰æ‹©æ•°é‡ -->
            <text class="selected-count" wx:if="{{tabType === 'multiple'}}">å·²é€‰æ‹© {{selectedDestinations.length}} ä¸ª</text>
          </view>
          
          <!-- å¤šé€‰æ¨¡å¼ä¸‹æ˜¾ç¤ºå·²é€‰æ‹©ç›®çš„åœ°çš„é¢„è§ˆ -->
          <view class="selected-preview" wx:if="{{tabType === 'multiple' && selectedDestinations.length > 0}}">
            <view class="preview-title">å·²é€‰æ‹©çš„ç›®çš„åœ°ï¼š</view>
            <view class="selected-tags">
              <view class="selected-tag" 
                    wx:for="{{selectedDestinations}}" 
                    wx:key="id">
                <text class="tag-text">{{item.name}}</text>
                <text class="tag-remove" 
                      bindtap="removeDestination" 
                      data-destination-id="{{item.id}}">Ã—</text>
              </view>
            </view>
          </view>
          
          <view class="destination-items">
            <view class="destination-item {{item.selected ? 'selected' : ''}}" 
                  wx:for="{{currentDestinations}}" 
                  wx:key="id" 
                  bindtap="selectDestination" 
                  data-destination="{{item}}">
              <view class="destination-info">
                <text class="destination-name">{{item.name}}</text>
                <text class="destination-codes">{{item.codes}}</text>
              </view>
              <view class="destination-check" wx:if="{{tabType === 'multiple'}}">
                <text class="check-icon" wx:if="{{item.selected}}">âœ“</text>
                <view class="check-placeholder" wx:else></view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- å¤šé€‰æ¨¡å¼ä¸‹çš„ç¡®å®šæŒ‰é’® -->
      <view class="confirm-section" wx:if="{{tabType === 'multiple'}}">
        <button class="confirm-button {{selectedDestinations.length > 0 ? 'active' : 'disabled'}}" 
                bindtap="confirmMultipleDestinations"
                disabled="{{selectedDestinations.length === 0}}">
          ç¡®å®šé€‰æ‹© ({{selectedDestinations.length}})
        </button>
      </view>
    </view>
  </view>

  <!-- æ—¶é—´é€‰æ‹©å™¨ -->
  <view class="time-selector" wx:if="{{showTimeSelector}}" bindtap="hideTimeSelector">
    <view class="time-selector-content" catchtap="stopPropagation">
      <!-- é€‰æ‹©å™¨å¤´éƒ¨ -->
      <view class="time-selector-header">
        <view class="header-title-section">
          <text class="header-title">ä½ æƒ³å»å¤šä¹…ï¼Ÿ</text>
          <view class="date-type-toggle">
            <view class="toggle-button {{isFlexible ? 'active' : ''}}" bindtap="switchDateType" data-type="flexible">
              <text>çµæ´»å¤©æ•°</text>
            </view>
            <view class="toggle-button {{!isFlexible ? 'active' : ''}}" bindtap="switchDateType" data-type="fixed">
              <text>å›ºå®šæ—¥æœŸ</text>
            </view>
          </view>
        </view>
        <view class="header-right" bindtap="hideTimeSelector">
          <text class="close-icon">âœ•</text>
        </view>
      </view>
      
      <!-- çµæ´»å¤©æ•°çš„å¤©æ•°é€‰æ‹© -->
      <view class="flexible-days" wx:if="{{isFlexible && !selectedDays}}">
        <view class="days-grid">
          <view class="day-item {{selectedDays === item ? 'active' : ''}}" 
                wx:for="{{[2,3,4,5,6,7,8]}}" 
                wx:key="*this" 
                bindtap="selectDays" 
                data-days="{{item}}">
            <text>{{item}}</text>
          </view>
        </view>
      </view>

      <!-- æ—¥å†åŒºåŸŸ - åªåœ¨å›ºå®šæ—¥æœŸæ¨¡å¼ä¸‹æ˜¾ç¤º -->
      <view class="calendar-section" wx:if="{{!isFlexible}}">
        <view class="calendar-header">
          <view class="calendar-nav" bindtap="previousMonth">
            <text class="nav-icon">â€¹</text>
          </view>
          <view class="calendar-title">
            <text>{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
          </view>
          <view class="calendar-nav" bindtap="nextMonth">
            <text class="nav-icon">â€º</text>
          </view>
        </view>

        <!-- æ˜ŸæœŸæ ‡é¢˜ -->
        <view class="weekdays">
          <view class="weekday" wx:for="{{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']}}" wx:key="*this">
            <text>{{item}}</text>
          </view>
        </view>

        <!-- æ—¥æœŸç½‘æ ¼ -->
        <view class="calendar-grid">
          <view class="calendar-day {{item.isCurrentMonth ? '' : 'other-month'}} {{item.isSelected ? 'selected' : ''}} {{item.isInRange ? 'in-range' : ''}} {{item.isToday ? 'today' : ''}}"
                wx:for="{{calendarDays}}" 
                wx:key="date"
                bindtap="{{item.isCurrentMonth ? 'selectDate' : ''}}" 
                data-date="{{item.date}}"
                data-is-current-month="{{item.isCurrentMonth}}">
            <view class="day-number">{{item.day}}</view>
            <text class="holiday-mark" wx:if="{{item.isHoliday}}">ä¼‘</text>
          </view>
        </view>
      </view>

      <!-- é€‰æ‹©çš„æ—¥æœŸæ˜¾ç¤º - åªåœ¨å›ºå®šæ—¥æœŸæ¨¡å¼ä¸‹æ˜¾ç¤º -->
      <view class="selected-date-display" wx:if="{{!isFlexible && selectedRange.start}}">
        <view class="date-info">
          <view class="date-label">æ—…è¡Œæ—¥æœŸ</view>
          <view class="date-range">{{selectedRange.display}}</view>
        </view>
        <view class="date-duration" wx:if="{{selectedRange.days}}">
          <text>{{selectedRange.days}}å¤©</text>
        </view>
      </view>

      <!-- çµæ´»å¤©æ•°ç¡®è®¤æ˜¾ç¤º -->
      <view class="flexible-duration-display" wx:if="{{isFlexible && selectedDays > 0}}">
        <view class="flexible-duration-info">
          <view class="flexible-duration-label">é€‰æ‹©çš„æ—…è¡Œå¤©æ•°</view>
          <view class="flexible-duration-value">{{selectedDays}}å¤©</view>
        </view>
      </view>

      <!-- ç¡®å®šæŒ‰é’® -->
      <button class="confirm-button {{(isFlexible && selectedDays > 0) || (!isFlexible && selectedRange.end) ? 'active' : 'disabled'}}" 
              bindtap="confirmTimeSelection" 
              disabled="{{(isFlexible && selectedDays <= 0) || (!isFlexible && !selectedRange.end)}}">
        ç¡®å®š
      </button>
    </view>
  </view>
</view> 